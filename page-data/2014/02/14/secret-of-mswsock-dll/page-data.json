{"componentChunkName":"component---src-templates-page-tsx","path":"/2014/02/14/secret-of-mswsock-dll/","result":{"data":{"site":{"siteMetadata":{"title":"Lacti's Archive","description":"All about I learned","author":{"name":"Jaeyoung, Choi","url":"https://twitter.com/lacti"}}},"markdownRemark":{"html":"<p>최근 회사에서 c#으로 네트워크 프로그래밍을 하고 있다. 일은 아니고 그냥 개인의 취향\n나름 c#도 속도가 괜찮다는 것을 보여주려고 시작을 했는데, 진행하면서 점점 보이는 결과는 영 좋지 않다.</p>\n<p>서버 과부하 테스트 프로그램을 c#으로 porting했다. 정말 과부하 테스트를 하려면 c++로 작성해야 맞지만 테스트 로직까지 c++로 작성하면 골치가 아프니 core는 c++, logic은 c#으로 작성하는 방법을 고민하면서 porting을 하고 있다. 하지만 그 전에 귀찮으니 일단 network core도 c#으로 작성했고 이 때 c# async io와 async/await을 대충 섞어서 작성했다.</p>\n<p><strong>정말 대충 짰더니 정말 성능이 대충 나온다(…)</strong>\nvs analyze 기능을 통해 확인을 해보면 가장 오래 걸리는 부분이 mswsock.dll에 소속되어 있다고 나온다. 이 글은 대체 왜 mswsock.dll인가에 대한 고찰을 담은 글이다.</p>\n<p>.net <code>Socket</code>의 <code>BeginReceive</code>, <code>EndReceive</code> 함수를 사용하면 내부에서 pinvoke로 <code>WSARecv</code> 함수를 부르게 된다. <code>WSARecv</code> 함수는 <code>ws2_32.dll</code>에 정의된 함수로 얼핏보기에는 socket 확장 api가 담겨있는 <code>mswsock.dll</code>이 부를 필요가 없어 보인다. 이를 정확히 확인하기 위해 ms symbol server에서 clr 관련 symbol을 받고 다시 profiler를 돌려보았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 766px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.08771929824561%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7EAAAOwwHaapjcAAABC0lEQVQY00WQCY6EIBREuf+12g2xWwVkdRk3sG8xpUwyiZjK57+qUlJWtKQ0ywoh1bz8TDjrFuLl/CilOs54hmism5c1Xl+ltTb2DNd+nLgleVHheb3y96eVg1LaggYA+NN2G7ZCBGCdD9eXC9lzAUfMIQhjb8aarudaWyxxLoCBmKYZet0OaG1vGC4AHjigXdv1pGasZg2ljNK6oqwoK6UNvOd5wfX6RBv09iNgZCQYc2hykzWraI3mWZZDKAU4zMs/7Jz345SSOZf7AXhLtRt8LQprY4ANg8LeDf8lH6DBpmS0F3LABJ74QQQoPKz1aGudw9u5MSX3PU/J+ukdQhRCou1+hm3b2677BfScY3xMEsjnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"functions\"\n        title=\"functions\"\n        src=\"/static/87f8a5582a10c6a5a18de6e6215a7f60/0af7c/mswsock_secret_functions.png\"\n        srcset=\"/static/87f8a5582a10c6a5a18de6e6215a7f60/5459c/mswsock_secret_functions.png 285w,\n/static/87f8a5582a10c6a5a18de6e6215a7f60/2cee3/mswsock_secret_functions.png 570w,\n/static/87f8a5582a10c6a5a18de6e6215a7f60/0af7c/mswsock_secret_functions.png 766w\"\n        sizes=\"(max-width: 766px) 100vw, 766px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>진범이 나온 것 같다. <code>NtDeviceIoControlFile()</code>과 <code>NtRemoveIoCompletion()</code>이 1, 2위로 나왔다. 여기서 <code>NtRemoveIoCompletion()</code> 함수는 <code>GetQueuedCompletionStatus()</code> 때문에 불리는 것으로 추측되니 <code>NtDeviceIoControlFile()</code>의 정체만 밝히면 되겠다.</p>\n<p>간단히 calling, called를 확인해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1140px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.31578947368421%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABPElEQVQY0wExAc7+AM/M09XS2dvZ4NvZ4NvZ4NvZ4NXV3tTU3NTU3NjY4NfY4NfY39fY4NTV3dbU29jX3tva4dva4dva4drZ4QBjr9FfrtJrttlvudtyut10vN6/2OOFvNVytdN8vtyAwN6Bwt+RyeLA1+Bmrctpr9BttNRvtdVyt9d8vdoAMZvNKpjNL5rOMpzPNp7RPKPUstTlTqfQN5zNQqPRRaXTRqbVWa7Ys9PhP5nCOpbBPJjCP5vEQ5zGVafNADCPuymMuy+PvTKSvjaUwDyYw7DQ3j2WwCGIuS2OvTGRvjGRv0WcxrLR30KdxzSWxDmZxj2cyUGfylWq0QBQmbpKl7lTnL1Wnb5an79cocG91d9ho8FLl7pVnL1Yn75Zn8BpqMW+1+JhrM5ZqM1dq85hrtFlr9J0uNdrSsRLn7rQVgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ws2_32.dll\"\n        title=\"ws2_32.dll\"\n        src=\"/static/274bc6a9a48586b9e4c6d84d1bc244dc/267c0/mswsock_secret_ws2_32_dll.png\"\n        srcset=\"/static/274bc6a9a48586b9e4c6d84d1bc244dc/5459c/mswsock_secret_ws2_32_dll.png 285w,\n/static/274bc6a9a48586b9e4c6d84d1bc244dc/2cee3/mswsock_secret_ws2_32_dll.png 570w,\n/static/274bc6a9a48586b9e4c6d84d1bc244dc/267c0/mswsock_secret_ws2_32_dll.png 1140w,\n/static/274bc6a9a48586b9e4c6d84d1bc244dc/e217c/mswsock_secret_ws2_32_dll.png 1205w\"\n        sizes=\"(max-width: 1140px) 100vw, 1140px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1140px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.964912280701757%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABMklEQVQY0yXK206CYADAcR6mC50dPGOz7Kq5latH6G3U0nQVAZKHDmtueROIuuXKmYiCJYjygSJ81Oo9otp+V//9kTf+XRJkMJkvNegwNDidmvrs1wLAP5YOLCcu1KUBrP/N4XQk3Z4eP6sYb17yFjmEV6ItzD9KHCB6oCzCogjLI7s2+RzqMN1Wsh0N4y18YJGCXRRMxF0Yr5CSh5I3Soq/Movea3X1+6A6id3I8aq69wD2a/pR3aBnXx5q7KLktaLsLSuBa3W3qiIhrOs97wax1wjJRQt8vCKwir1V4Fz5jh/roUQ/TPQTdyNGgSjeRfEeinObZH+bGhzeishqinYnad8JG8w20Fxr5+KJkczYWdOdfAxkWDTXCOeaCeqFloz1NONJ0b4MGzptRPKtONH+AQN8ww9ZK9p8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mswsock.dll\"\n        title=\"mswsock.dll\"\n        src=\"/static/8caaedce047ba57837f09a099ac8c1ea/267c0/mswsock_secret_mswsock_dll.png\"\n        srcset=\"/static/8caaedce047ba57837f09a099ac8c1ea/5459c/mswsock_secret_mswsock_dll.png 285w,\n/static/8caaedce047ba57837f09a099ac8c1ea/2cee3/mswsock_secret_mswsock_dll.png 570w,\n/static/8caaedce047ba57837f09a099ac8c1ea/267c0/mswsock_secret_mswsock_dll.png 1140w,\n/static/8caaedce047ba57837f09a099ac8c1ea/610eb/mswsock_secret_mswsock_dll.png 1201w\"\n        sizes=\"(max-width: 1140px) 100vw, 1140px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>원인이 명확해졌다.\n다량의 패킷 수신자가 <code>WSARecv</code>를 부르는 과정에서 <code>ws2_32.dll</code>의 함수가 호출된 것은 당연했다. 하지만 그 과정에서 알 수 없는 오류가 발생했고, 그 오류를 처리하기 위해 불린 <code>NtStatusToSocketError()</code> 함수가 <code>mswsock.dll</code>의 <code>NtDeviceIoControlFile()</code> 함수를 불렀던 것이다.</p>\n<p>그렇다면 <code>NtDeviceIoControlFile()</code> 함수는 대체 무엇일까, 그리고 왜 그렇게 느릴까?\nprofiling한 결과를 보면 대부분의 exclusive sample의 address가 비슷한 지점을 가리키고 있는 것을 확인할 수 있다. 즉, 특정 지점에서 많이 멈춰있다는 이야기일 것인데, 이 때 cpu 사용량이 꽤 높다는 점을 미루어볼 때 뭔가 busy waiting을 하는 것이 아닐까 추측된다.</p>\n<p>이 부분은 symbol 만으로 확인하기는 어렵고, 직접 disassemble을 해서 확인을 하던가 해야하지만 별로 그러고 싶지는 않고(…) 일단 pinvoke로 직접 iocp를 호출하는 c# 코드를 작성하여 그 부분에서도 여전히 비슷한 문제가 발생하는지 확인을 해봐야겠다.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","excerpt":"최근 회사에서 c#으로 네트워크 프로그래밍을 하고 있다. 일은 아니고 그냥 개인의 취향\n나름 c#도 속도가 괜찮다는 것을 보여주려고 시작을 했는데, 진행하면서 점점 보이는 결과는 영 좋지 않다. 서버 과부하 테스트 프로그램을 c#으로 porting…","fields":{"date":"February 14, 2014","shortdesc":"","slug":"/2014/02/14/secret-of-mswsock-dll/"},"frontmatter":{"title":"mswsock.dll의 비밀","tags":["optimization","network","c#"]}}},"pageContext":{"slug":"/2014/02/14/secret-of-mswsock-dll/","older":{"slug":"/2014/02/11/fast-message-serialization/","title":"빠른 메시지 만들기"},"newer":{"slug":"/2014/02/16/network-offload-error/","title":"네트워크 offload 장애"}}},"staticQueryHashes":["848695393"]}