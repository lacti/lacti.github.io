{"componentChunkName":"component---src-templates-page-tsx","path":"/2013/08/12/implements-producer-consumer-model/","webpackCompilationHash":"e5e0a94e368acafd71f1","result":{"data":{"site":{"siteMetadata":{"title":"Lacti's Archive","description":"All about I learned","author":{"name":"Jaeyoung, Choi","url":"https://twitter.com/lacti"}}},"markdownRemark":{"html":"<p>먹깨비 과제를 풀어보자. 여러 가지 구현법이 있을 것인데, 나는 간단하게</p>\n<ul>\n<li>바구니는 공유 자원이니 lock으로 보호하고,</li>\n<li>제빵사와 먹깨비는 actor로 만들어서 매 tick마다 상황 판단 후 작업을 처리하도록 했다.</li>\n</ul>\n<p>따라서 공유 자원을 보호하기 위한 <code>spin_lock</code>과 actor 기반 코드를 만들었고 그 기반으로 바구니, 제빵사, 먹깨비를 만들었다.</p>\n<p>먼저 <code>spin_lock</code>을 만들어보자. 이전 글에서 몇 번 설명한적 있으니 대충 보자.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">spin_lock_t</span><span class=\"mtk1\">() { </span><span class=\"mtk12\">_flag</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clear</span><span class=\"mtk1\">(); }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acquire</span><span class=\"mtk1\">() { </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_flag</span><span class=\"mtk1\">.</span><span class=\"mtk11\">test_and_set</span><span class=\"mtk1\">()); }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">release</span><span class=\"mtk1\">() { </span><span class=\"mtk12\">_flag</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clear</span><span class=\"mtk1\">(); }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    std::atomic_flag _flag;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">explicit</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\">(</span><span class=\"mtk10\">spin_lock_t</span><span class=\"mtk1\">&amp; lock)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_lock</span><span class=\"mtk1\">(&amp;</span><span class=\"mtk12\">lock</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_lock</span><span class=\"mtk1\">-&gt;</span><span class=\"mtk11\">acquire</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">spin_lock_raii_t</span><span class=\"mtk1\">(</span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\">&amp;&amp; </span><span class=\"mtk12\">other</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_lock</span><span class=\"mtk1\">(other._lock) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">other._lock</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">nullptr</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">~spin_lock_raii_t</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (_lock != </span><span class=\"mtk4\">nullptr</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_lock</span><span class=\"mtk1\">-&gt;</span><span class=\"mtk11\">release</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">spin_lock_raii_t</span><span class=\"mtk1\">(</span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\">&amp;);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\">&amp; operator = (</span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\">&amp;);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">spin_lock_t</span><span class=\"mtk1\">* _lock;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">template</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk4\">size_t </span><span class=\"mtk10\">_lockCount</span><span class=\"mtk1\">&gt;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_support_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">spin_lock_raii_t</span><span class=\"mtk1\"> </span><span class=\"mtk11\">lock</span><span class=\"mtk1\">(</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lock_index</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">spin_lock_raii_t</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_lock</span><span class=\"mtk1\">[lock_index]);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">spin_lock_t</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lock</span><span class=\"mtk1\">[_lockCount];</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<ul>\n<li><code>spin_lock</code> 자체는 <code>atomic_flag</code>를 사용하여 간단히 만들었다.</li>\n<li><code>spin_lock_raii</code>는 <code>spin_lock</code>을 가지고 생성자/소멸자에서 <code>acquire</code>, <code>release</code>해주는 raii class이다.</li>\n<li>그리고 <code>spin_lock_support</code>를 만들어서 lock이 필요한 class에서 이를 상속받아 사용할 수 있도록 코드를 작성하였다. 상황에 따라 lock을 여러 개 사용할 수도 있으므로 lock 개수를 template 인자로 받도록 하였다.</li>\n</ul>\n<p>이를 사용하여 구현한 바구니(basket)은 다음과 같다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">basket_t</span><span class=\"mtk1\"> : </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">spin_lock_support_t</span><span class=\"mtk1\">&lt;</span><span class=\"mtk7\">1</span><span class=\"mtk1\">&gt; {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">basket_t</span><span class=\"mtk1\">() : </span><span class=\"mtk11\">_bread_count</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {}</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk11\">count</span><span class=\"mtk1\">() </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> _bread_count; }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">add</span><span class=\"mtk1\">() { ++_bread_count; }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sub</span><span class=\"mtk1\">() { --_bread_count; }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> _bread_count;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p>lock을 여러 개 사용할 필요가 없으니 <code>spin_lock_support</code>의 template 인자를 1로 지정하여 사용하였다. 이제 다른 actor에서 바구니를 접근할 때에는 다음과 같이 사용할 수 있다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">auto</span><span class=\"mtk1\"> locker = basket.</span><span class=\"mtk11\">lock</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (basket.</span><span class=\"mtk11\">count</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk7\">20</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">basket.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">();</span></span></code></pre>\n<p>이제 actor를 만들어보자. ppl의 <code>concurrent_queue</code>는 너무 느려서 actor model의 mpsc queue를 구현하는데 적합하지 않은 것 같다. 따라서 <code>InterlockedSList</code>를 사용하여 간단히 구현해 보았다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">typedef</span><span class=\"mtk1\"> std::function&lt;</span><span class=\"mtk4\">void</span><span class=\"mtk1\">()&gt; </span><span class=\"mtk10\">message_t</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">actor_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">actor_t</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        _job_count = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">InitializeSListHead</span><span class=\"mtk1\">(&amp;_queue_head);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">post</span><span class=\"mtk1\">(</span><span class=\"mtk10\">message_t</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk10\">job_entry_t</span><span class=\"mtk1\"> : </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">SLIST_ENTRY</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk10\">message_t</span><span class=\"mtk1\"> message;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        };</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">void</span><span class=\"mtk1\">* entry_memory = </span><span class=\"mtk11\">_aligned_malloc</span><span class=\"mtk1\">(</span><span class=\"mtk4\">sizeof</span><span class=\"mtk1\">(</span><span class=\"mtk10\">message_t</span><span class=\"mtk1\">),</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            MEMORY_ALLOCATION_ALIGNMENT);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">job_entry_t</span><span class=\"mtk1\">* entry = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> (entry_memory) </span><span class=\"mtk10\">job_entry_t</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">entry-&gt;message</span><span class=\"mtk1\"> = message;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">bool</span><span class=\"mtk1\"> victim = </span><span class=\"mtk12\">_job_count</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fetch_add</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">InterlockedPushEntrySList</span><span class=\"mtk1\">(&amp;_queue_head, entry);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!victim) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> process_count = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">do</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            PSLIST_ENTRY local_head = </span><span class=\"mtk11\">InterlockedFlushSList</span><span class=\"mtk1\">(&amp;_queue_head);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            std::vector&lt;</span><span class=\"mtk10\">message_t</span><span class=\"mtk1\">&gt; messages;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserve</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1024</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            PSLIST_ENTRY it = local_head;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            PSLIST_ENTRY next = </span><span class=\"mtk4\">nullptr</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (it != </span><span class=\"mtk4\">nullptr</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                next = </span><span class=\"mtk12\">it-&gt;Next</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk10\">job_entry_t</span><span class=\"mtk1\">* each_entry = </span><span class=\"mtk4\">reinterpret_cast</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">job_entry_t</span><span class=\"mtk1\">*&gt;(it);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push_back</span><span class=\"mtk1\">(</span><span class=\"mtk12\">each_entry-&gt;message</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">each_entry-&gt;job_entry_t</span><span class=\"mtk1\">::</span><span class=\"mtk11\">~job_entry_t</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_aligned_free</span><span class=\"mtk1\">(each_entry);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                it = next;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">auto</span><span class=\"mtk1\"> it = </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">rbegin</span><span class=\"mtk1\">(); it != </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">rend</span><span class=\"mtk1\">(); ++it)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                (*it)();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            process_count = </span><span class=\"mtk11\">static_cast</span><span class=\"mtk1\">&lt;</span><span class=\"mtk4\">int</span><span class=\"mtk1\">&gt;(</span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">size</span><span class=\"mtk1\">());</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_job_count</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fetch_sub</span><span class=\"mtk1\">(process_count) != process_count);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">template</span><span class=\"mtk1\"> &lt;</span><span class=\"mtk4\">typename </span><span class=\"mtk10\">_SubTy</span><span class=\"mtk1\">&gt;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">post</span><span class=\"mtk1\">(</span><span class=\"mtk4\">void</span><span class=\"mtk1\"> (_SubTy::*method)()) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        _SubTy* sub_instance = </span><span class=\"mtk4\">static_cast</span><span class=\"mtk1\">&lt;_SubTy*&gt;(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">post</span><span class=\"mtk1\">([sub_instance, method] () { (</span><span class=\"mtk12\">sub_instance-&gt;*method</span><span class=\"mtk1\">)(); });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    SLIST_HEADER _queue_head;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    std::atomic_int _job_count;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p>원리는 간단하다.</p>\n<ul>\n<li>수행할 작업을 <code>void ()</code> 형태로 받아서 <code>InterlockedSList</code> 기반의 queue에 넣는다.</li>\n<li>그리고 처음 queue에 넣는 thread를 victim으로 삼아서 queue 내에 들어있는 작업들을 계속 처리하도록 한다.</li>\n<li>이 때 절묘한 타이밍으로 queue에 넣은 작업이 처리될 수 없는 문제를 해결하기 위해 <code>_job_count</code>로 처리 구간을 보장해준다.</li>\n</ul>\n<p>template 인자를 받는 <code>post()</code> 함수는 이 actor를 상속받은 하위 class들의 member function pointer를 받아서 this에 대해 <code>post()</code> 함수를 호출해주는 helper function이다. 이 helper function이 있으면 다음과 같이 간결하게 <code>post()</code>를 호출할 수 있다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk10\">eater_t</span><span class=\"mtk1\"> eater;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">eater.</span><span class=\"mtk11\">post</span><span class=\"mtk1\">(&amp;eater_t::act);</span></span></code></pre>\n<p><code>post()</code>가 가능한 actor 기반을 만들었으니, 이를 기반으로 주기적인 작업을 수행하기 위한 interface를 정의해보자. 간단히 다음과 같이 <code>tick_actor_t</code>를 선언하였다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">tick_actor_t</span><span class=\"mtk1\"> : </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">actor_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">act</span><span class=\"mtk1\">() = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p><code>tick_actor_t</code> class는 주기적으로 <code>act()</code> 함수가 불려져서 뭔가 지속적인 작업을 처리할 수 있도록 하는 의미를 지닌 interface이다.</p>\n<p>그러한 방식으로 구현이 되려면 다음의 개념이 필요하다.</p>\n<ul>\n<li>누가(어떤 thread가) 해당 actor를 도맡아서 주기적으로 <code>act()</code> 함수를 불러주는가?</li>\n</ul>\n<p>결국 thread를 관리하고, 각 thread에게 (대충) 공평하게 actor를 분배하고, 각 thread는 담당하는 actor를 처리하는 구조를 작성하여야 한다. 이에 대해서는 다음과 같은 개념으로 구현을 하였다.</p>\n<ul>\n<li><em>시나리오</em>를 통해 어떤 actor가 등장할지 각 thread에게 전달된다.</li>\n<li>각 <em>일꾼(worker-thread)</em>들은 시나리오를 보고 자기가 담당해야 할 역할(actor)을 기억한다.</li>\n<li>각 <em>일꾼(worker-thread)</em>들은 자기가 연기할 대상(actor)을 주기적으로 연기(act)한다.</li>\n</ul>\n<p>해서 <code>scenario</code>, <code>worker</code>, 그리고 worker를 관리하기 위한 <code>worker_pool</code> class가 등장하였다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">scenario_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">typedef</span><span class=\"mtk1\"> std::function&lt;</span><span class=\"mtk10\">tick_actor_t</span><span class=\"mtk1\">* ()&gt; </span><span class=\"mtk10\">tick_actor_factory_t</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">typedef</span><span class=\"mtk1\"> concurrency::concurrent_queue&lt;</span><span class=\"mtk10\">tick_actor_factory_t</span><span class=\"mtk1\">&gt; </span><span class=\"mtk10\">tick_actor_factory_queue_t</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">scenario_t</span><span class=\"mtk1\">(</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">worker_count</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_worker_count</span><span class=\"mtk1\">(worker_count) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        _worker_sched_index = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        _tick_actor_factory_queue_array = new </span><span class=\"mtk10\">tick_actor_factory_queue_t</span><span class=\"mtk1\">[worker_count];</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">~scenario_t</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        delete[] _tick_actor_factory_queue_array;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk11\">get_worker_count</span><span class=\"mtk1\">() </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> _worker_count; }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">enter</span><span class=\"mtk1\">(</span><span class=\"mtk10\">tick_actor_factory_t</span><span class=\"mtk1\"> </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> current_sched_index = _worker_sched_index++ % _worker_count;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_tick_actor_factory_queue_array</span><span class=\"mtk1\">[current_sched_index].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(factory);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">tick_actor_factory_queue_t</span><span class=\"mtk1\">&amp; </span><span class=\"mtk11\">get_factory_queue</span><span class=\"mtk1\">(</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(index &gt;= </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; index &lt; _worker_count);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tick_actor_factory_queue_array</span><span class=\"mtk1\">[index];</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> _worker_count;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    std::atomic_int _worker_sched_index;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">tick_actor_factory_queue_t</span><span class=\"mtk1\">* _tick_actor_factory_queue_array;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p><code>scenario</code> class는 일꾼(worker)의 총 수가 몇 명인지 가지고 있다가, 어떤 배역(actor)이 등장(enter)하게 될 경우 round-robin 방식으로 각 worker와 연결된 queue에 배역 생성기(actor)를 넣어준다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">worker_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">worker_t</span><span class=\"mtk1\">(</span><span class=\"mtk10\">scenario_t</span><span class=\"mtk1\">&amp; </span><span class=\"mtk12\">scenario</span><span class=\"mtk1\">, </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_scenario</span><span class=\"mtk1\">(scenario), </span><span class=\"mtk11\">_index</span><span class=\"mtk1\">(index) {}</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">work</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">typedef</span><span class=\"mtk1\"> std::vector&lt;</span><span class=\"mtk10\">tick_actor_t</span><span class=\"mtk1\">*&gt; </span><span class=\"mtk10\">tick_actors_t</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">tick_actors_t</span><span class=\"mtk1\"> tick_actors;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">auto</span><span class=\"mtk1\">&amp; factory_queue = </span><span class=\"mtk12\">_scenario</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_factory_queue</span><span class=\"mtk1\">(_index);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            scenario_t::</span><span class=\"mtk10\">tick_actor_factory_t</span><span class=\"mtk1\"> factory;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk15\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">factory_queue</span><span class=\"mtk1\">.</span><span class=\"mtk11\">try_pop</span><span class=\"mtk1\">(factory)) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk4\">auto</span><span class=\"mtk1\">* new_actor = </span><span class=\"mtk11\">factory</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">tick_actors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push_back</span><span class=\"mtk1\">(new_actor);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">auto</span><span class=\"mtk1\"> it = </span><span class=\"mtk12\">tick_actors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">begin</span><span class=\"mtk1\">(); it != </span><span class=\"mtk12\">tick_actors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">end</span><span class=\"mtk1\">(); ++it) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk4\">auto</span><span class=\"mtk1\">&amp; actor = *(*it);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">actor</span><span class=\"mtk1\">.</span><span class=\"mtk11\">post</span><span class=\"mtk1\">(&amp;tick_actor_t::act);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> _index;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">scenario_t</span><span class=\"mtk1\">&amp; _scenario;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p><code>worker</code> class에서는 자신에게 할당된 (scenario에서 enter하면 추가되는) 배역 생성 queue를 확인하여 새로 부여받은 배역(actor)이 있나 확인하여 자신이 관리하는 vector에 넣는다.\n그리고 자신이 관리하는 모든 배역(actor)에 대해 <code>act()</code> 함수를 호출함으로써 각자의 <code>act()</code> 함수가 호출될 수 있도록 한다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">worker_pool_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">worker_pool_t</span><span class=\"mtk1\">(</span><span class=\"mtk10\">scenario_t</span><span class=\"mtk1\">&amp; </span><span class=\"mtk12\">scenario</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_scenario</span><span class=\"mtk1\">(scenario) { </span><span class=\"mtk11\">employ</span><span class=\"mtk1\">(); }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">~worker_pool_t</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">employ</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> index = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; index &lt; </span><span class=\"mtk12\">_scenario</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get_worker_count</span><span class=\"mtk1\">(); ++index) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_workers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push_back</span><span class=\"mtk1\">(std::</span><span class=\"mtk11\">thread</span><span class=\"mtk1\">([</span><span class=\"mtk4\">this</span><span class=\"mtk1\">, index] () {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk10\">worker_t</span><span class=\"mtk1\"> </span><span class=\"mtk11\">worker</span><span class=\"mtk1\">(_scenario, index);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">worker</span><span class=\"mtk1\">.</span><span class=\"mtk11\">work</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            }));</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">auto</span><span class=\"mtk1\">&amp; each : _workers) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk12\">each</span><span class=\"mtk1\">.</span><span class=\"mtk11\">join</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_workers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clear</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">scenario_t</span><span class=\"mtk1\">&amp; _scenario;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    std::vector&lt;std::thread&gt; _workers;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p>그리고 <code>worker_pool</code> class에서 각 worker에 thread를 부여하고 이것들을 관리할 수 있도록 간단히 코드를 작성하였다.</p>\n<p>기반 코드 작성이 끝났으니 먹깨비와 제빵사를 구현해보자.\n<code>tick_actor</code> class의 <code>act()</code> 함수만 채우면 되니 간단하다.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">baker_t</span><span class=\"mtk1\"> : </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">tick_actor_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">baker_t</span><span class=\"mtk1\">(</span><span class=\"mtk10\">basket_t</span><span class=\"mtk1\">&amp; </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_basket</span><span class=\"mtk1\">(basket) {}</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">act</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">auto</span><span class=\"mtk1\"> locker = </span><span class=\"mtk12\">_basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lock</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">count</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk7\">20</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">basket_t</span><span class=\"mtk1\">&amp; _basket;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">eater_t</span><span class=\"mtk1\"> : </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">tick_actor_t</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">public:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">eater_t</span><span class=\"mtk1\">(</span><span class=\"mtk10\">basket_t</span><span class=\"mtk1\">&amp; </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        : </span><span class=\"mtk11\">_basket</span><span class=\"mtk1\">(basket) {}</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">act</span><span class=\"mtk1\">() {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk4\">auto</span><span class=\"mtk1\"> locker = </span><span class=\"mtk12\">_basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lock</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">count</span><span class=\"mtk1\">() &lt;= </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">();</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk4\">private:</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">basket_t</span><span class=\"mtk1\">&amp; _basket;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">};</span></span></code></pre>\n<p>각자는 <code>act()</code> 함수에서 자신이 참조하는 바구니에 <code>lock()</code>을 걸고, 문제의 제약조건에 따라 <code>count()</code>를 확인한 뒤 <code>add()</code> or <code>sub()</code>을 수행한다.</p>\n<p>여기까지 만들고 보면 결국 공유 자원은 lock으로 보호되고, actor간의 message 통신이 없으므로 <code>post()</code> 함수가 무의미해졌다는 사실을 깨달을 수 있게 된다!</p>\n<p>이제 main 함수에서 시나리오를 구성해보자.</p>\n<pre class=\"default-dark vscode-highlight\" data-language=\"cpp\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_tmain</span><span class=\"mtk1\">(</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">argc</span><span class=\"mtk1\">, _TCHAR* </span><span class=\"mtk12\">argv</span><span class=\"mtk1\">[])</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">{</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">scenario_t</span><span class=\"mtk1\"> </span><span class=\"mtk11\">scenario</span><span class=\"mtk1\">(std::thread::</span><span class=\"mtk11\">hardware_concurrency</span><span class=\"mtk1\">());</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">worker_pool_t</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pool</span><span class=\"mtk1\">(scenario);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">basket_t</span><span class=\"mtk1\"> basket;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> index = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; index &lt; </span><span class=\"mtk7\">10</span><span class=\"mtk1\">; ++index)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">scenario</span><span class=\"mtk1\">.</span><span class=\"mtk11\">enter</span><span class=\"mtk1\">([&amp;basket] () { </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> new </span><span class=\"mtk11\">baker_t</span><span class=\"mtk1\">(basket); });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">int</span><span class=\"mtk1\"> index = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; index &lt; </span><span class=\"mtk7\">10</span><span class=\"mtk1\">; ++index)</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">scenario</span><span class=\"mtk1\">.</span><span class=\"mtk11\">enter</span><span class=\"mtk1\">([&amp;basket] () { </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> new </span><span class=\"mtk11\">eater_t</span><span class=\"mtk1\">(basket); });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">}</span></span></code></pre>\n<p><code>scenario</code>를 먼저 만든다. 일꾼(<code>worker</code>) 수는 하드웨어가 지원하는 thread 개수로 지정한다. 이제 만들어진 <code>scenario</code> 객체로 <code>worker_pool</code> 객체를 만들면 일꾼들이 고용(employ)되어 준비가 완료된다.</p>\n<p>배역들을 등장시키기 위해 <code>scenario</code>의 <code>enter()</code> 함수를 불러준다. 생성하는 코드 자체를 template 등으로 감쌀수도 있겠지만 그러면 코드가 복잡해지니 간단히 lambda로 구현한 factory method를 전달하였다. 이제 제빵사와 먹깨비가 round-robin 방식으로 각 worker에게 배정되어 관리될 것이다.</p>\n<p>간단한 내용을 무의미하게 길게 코딩하는 법을 소개해 보았다.\n처음 과제 자체가 actor model에 익숙해지는 것을 위해 multi-thread 동기화 예제를 좀 무리하게 냈던 것인데, 스터디에 참여했단 다른 친구들이 나처럼 의미없는 actor model을 구현하지 않고 재미있는 model을 구현해 주어서 참 다행이었다(…)</p>\n<style class=\"vscode-highlight-styles\">:root {\n  --vscode-highlight-padding-v: 1rem;\n  --vscode-highlight-padding-h: 1.5rem;\n  --vscode-highlight-padding-top: var(--vscode-highlight-padding-v);\n  --vscode-highlight-padding-right: var(--vscode-highlight-padding-h);\n  --vscode-highlight-padding-bottom: var(--vscode-highlight-padding-v);\n  --vscode-highlight-padding-left: var(--vscode-highlight-padding-h);\n  --vscode-highlight-border-radius: 8px;\n\n  --vscode-highlight-line-highlighted-background-color: transparent;\n  --vscode-highlight-line-highlighted-border-width: 4px;\n  --vscode-highlight-line-highlighted-border-color: transparent;\n}\n\n.vscode-highlight {\n  overflow: auto;\n  -webkit-overflow-scrolling: touch;\n  padding-top: 1rem;\n  padding-top: var(--vscode-highlight-padding-top);\n  padding-bottom: 1rem;\n  padding-bottom: var(--vscode-highlight-padding-bottom);\n  border-radius: 8px;\n  border-radius: var(--vscode-highlight-border-radius);\n  font-feature-settings: normal;\n}\n\n.vscode-highlight-code {\n  display: inline-block;\n  min-width: 100%;\n}\n\n.vscode-highlight-line {\n  display: inline-block;\n  box-sizing: border-box;\n  width: 100%;\n  padding-left: 1.5rem;\n  padding-left: var(--vscode-highlight-padding-left);\n  padding-right: 1.5rem;\n  padding-right: var(--vscode-highlight-padding-right);\n}\n\n.vscode-highlight-line-highlighted {\n  background-color: var(--vscode-highlight-line-highlighted-background-color);\n  box-shadow: inset var(--vscode-highlight-line-highlighted-border-width) 0 0 0 var(--vscode-highlight-line-highlighted-border-color);\n}\n.default-dark {\nbackground-color: #1E1E1E;\ncolor: #D4D4D4;\n}\n\n.default-dark .mtk1 { color: #D4D4D4; }\n.default-dark .mtk2 { color: #1E1E1E; }\n.default-dark .mtk3 { color: #6A9955; }\n.default-dark .mtk4 { color: #569CD6; }\n.default-dark .mtk5 { color: #D16969; }\n.default-dark .mtk6 { color: #D7BA7D; }\n.default-dark .mtk7 { color: #B5CEA8; }\n.default-dark .mtk8 { color: #CE9178; }\n.default-dark .mtk9 { color: #646695; }\n.default-dark .mtk10 { color: #4EC9B0; }\n.default-dark .mtk11 { color: #DCDCAA; }\n.default-dark .mtk12 { color: #9CDCFE; }\n.default-dark .mtk13 { color: #000080; }\n.default-dark .mtk14 { color: #F44747; }\n.default-dark .mtk15 { color: #C586C0; }\n.default-dark .mtk16 { color: #6796E6; }\n.default-dark .mtk17 { color: #808080; }\n.default-dark .mtki { font-style: italic; }\n.default-dark .mtkb { font-weight: bold; }\n.default-dark .mtku { text-decoration: underline; text-underline-position: under; }</style>","excerpt":"먹깨비 과제를 풀어보자. 여러 가지 구현법이 있을 것인데, 나는 간단하게바구니는 공유 자원이니 lock으로 보호하고,제빵사와 먹깨비는 actor로 만들어서 매 tick마다 상황 판단 후 작업을 처리하도록 했다.따라서 공유 자원을 보호하기 위한 spin…","fields":{"date":"August 12, 2013","shortdesc":""},"frontmatter":{"title":"producer/consumer model 구현","tags":["concurrency","c++","study"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2013/08/12/implements-producer-consumer-model/"}}}